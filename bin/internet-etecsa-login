#!/bin/bash

#
# Renova la ip WAN de un dispositivo AirOS.
# 



# precondiciones para conectarse a internet

## alistar router de ser necesario
prepare_m5_dhcp() {
  local -r AUTH_NODE='secure.etecsa.net'
  local -r AIROS_DEVICE_IP='192.168.0.1'
# readonly AIROS_PASSWORD=''  
  # si el dispositivo AirOS no está disponible se imprime un mensaje y se sale
  timeout 1 ping -c 1 $AIROS_DEVICE_IP &> /dev/null || {
    echo "ERROR: Router inalcanzable" 1>&2
    return 1
  }
  # si el portal está disponible no se hace nada y se sale
  timeout 2 ping -c 1 $AUTH_NODE &> /dev/null && { 
    echo 'Router listo'
    return 0
  }
  notify-send "Preparando router..."
  # de no estar disponible el portal se renova la ip WAN del dispositivo AirOS, se imprime un mensaje y se sale
  # sshpass -p $AIROS_PASSWORD ssh "ubnt@$AIROS_DEVICE_IP" -- "udhcpc -f -q -n -i ath0 -s /etc/udhcpc/udhcpc renew" > /dev/null 2>&1 && {
  ssh -o 'ConnectTimeout=2' \
      -o 'BatchMode=yes' \
      -o 'UserKnownHostsFile=/dev/null' \
      -o 'StrictHostKeyChecking=no' \
      "ubnt@$AIROS_DEVICE_IP" -- \
      "udhcpc -f -q -n -i ath0 -s /etc/udhcpc/udhcpc renew" > /dev/null 2>&1 && {
    echo "Router listo, ip renovada"
    return 0
  }

  # de no poderse renovar la ip WAN del dispositivo AirOS se imprime un mensaje y se sale
  echo "ERROR: No se pudo renovar la ip del router" 1>&2
  return 1
}

code=0
scode=''
msg=''
msg="$(prepare_m5_dhcp 2>&1)" || code=$?

if [ "$code" = 0 ]; then
    # FIX: tomar el puerto de config
    msg="$(curl --silent --show-error 'http://localhost:4500/toggle' 2>&1)" || code=$?

    smsg="$(echo "$msg" | jq '.message')"
    smsg="${smsg:1:-1}" 
    scode="$(echo "$msg" | jq '.code')"
    scode="${scode:1:-1}"

    msg="${scode}|${smsg}"
    notify-send "$smsg"
else
  notify-send "$msg"
fi
# LOG
echo "$(date +%Y%m%d-%H%M%S)  [LOGGIN] ${code} ${msg}" >> '/var/log/internet-etecsa-login.log'