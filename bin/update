#!/bin/bash

##  Bash settings
# abort on nonzero exitstatus
set -o errexit
# abort on unbound variable
set -o nounset
# don't hide errors within pipes
# set -o pipefail
##

cd '/opt/internet-etecsa-login'
readonly LOG_FILE='/var/log/internet-etecsa-login.log'
readonly GIT_PACKAGE_URL="$(jq -r '.repository.url' './package.json' | sed 's/\.git$//' | sed 's/^git+//')/raw/branch/master/package.json"
readonly UPDATE_TODAY_OK="/tmp/internet-etecsa-login-$(date +%Y%m%d)"

log() {
  local -r code="$1"
  local msg="$2"
  if [ "$code" != 0 ]; then
    msg="ERROR: ${msg}"
  fi
  local -r entry="$(date +%Y%m%d-%H%M%S)  [UPDATE]  ${code} ${msg}"
  echo "$entry"
  echo "$entry" >> "$LOG_FILE"
}
# si la actualización se ejecutó hoy correctamente se sale
if [ -f "$UPDATE_TODAY_OK" ]; then
  echo 'No es necesario actualizar, ya se ha ejecutado hoy correctamente'
  exit 0
fi

# si no hay internet se sale
timeout 2 ping -c 1 8.8.8.8 &> /dev/null || {
  log 1 'No hay internet, no se ha podido actualizar'
  exit 1
}

# si la versión actual es la más reciente se sale
readonly cur_version="$(jq -r '.version' './package.json')"
readonly git_version="$(wget -qO - "$GIT_PACKAGE_URL" | jq -r '.version')"

if [[ "$cur_version" = "$git_version" ]]; then
  log 0 "No es necesario actualizar, la versión actual ${cur_version} es la más reciente"
  exit 0
fi
# actualizamos
git reset --hard
git pull origin master || {
  log 1 'ejecutando $ git pull origin master'
  exit 1
}
npm install --production --unsafe-perm=true || {
  log 1 'ejecutando $ npm install --production --unsafe-perm=true'
  exit 1
}
#
# este archivo se crea para evitar actualizar el mismo día después
# de una actualización exitosa
touch "$UPDATE_TODAY_OK"
# npm update --unsafe-perm=true
log 0 "Se ha actualizado de la versión ${cur_version} a ${git_version}"
# se reinicia el servicio solo si el usario no tiene una sesión abierta
# FIX: tomar puerto de config
msg="$(curl --silent --show-error 'http://localhost:4500/session-open' 2>&1)"
if [[ "$msg" != 'true' ]]; then
  systemctl restart internet-etecsa-login
  log 0 'Se ha reiniciado el servicio'
else
  log 0 'No se ha reiniciado el servicio porque hay una sesión abierta'
  notify-send 'Internet Login' "Software Actualizado a versión ${git_version}. Cuando cierre su sesión ejecute: $ sudo systemctl restart internet-etecsa-login"
fi